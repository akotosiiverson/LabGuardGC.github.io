<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Room Documents</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #333; text-align: center; }
        .status {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 4px solid #2196f3;
        }
        .error { background: #ffebee; border-left-color: #f44336; }
        .success { background: #e8f5e8; border-left-color: #4caf50; }
        button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover { background: #1976d2; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .log {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Fix Room Documents</h1>
        
        <div class="status" id="status">
            <strong>Ready to fix room documents</strong><br>
            This will add roomNumber field to all room documents and create PC documents.
        </div>
        
        <!-- Login Form -->
        <div id="loginForm" style="margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 5px;">
            <h3>Login Required</h3>
            <p>Please log in with your admin account:</p>
            <input type="email" id="emailInput" placeholder="Email" style="width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ccc; border-radius: 3px;">
            <input type="password" id="passwordInput" placeholder="Password" style="width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ccc; border-radius: 3px;">
            <button onclick="login()" style="background: #4caf50; color: white; border: none; padding: 10px 20px; border-radius: 3px; cursor: pointer;">Login</button>
        </div>
        
        <div id="authenticatedSection" style="display: none;">
            <div style="text-align: center;">
                <button id="fixBtn" onclick="fixRooms()">Fix Room Documents</button>
                <button id="createPCsBtn" onclick="createPCs()">Create PC Documents</button>
                <button onclick="clearLog()">Clear Log</button>
                <button onclick="logout()" style="background: #f44336;">Logout</button>
            </div>
        </div>
        
        <div class="log" id="log"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            setDoc, 
            getDocs,
            updateDoc
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword,
            signOut
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBvPjYdsbnuNtup1b1gnDDBlhMUJQt47qw",
            authDomain: "testingproject-b4bd5.firebaseapp.com",
            projectId: "testingproject-b4bd5",
            storageBucket: "testingproject-b4bd5.firebasestorage.app",
            messagingSenderId: "588414689097",
            appId: "1:588414689097:web:9bd56f9de5bbe0757dc498",
            measurementId: "G-YNNB1TT15X"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<strong>${message}</strong>`;
            statusDiv.className = `status ${type}`;
        }

        async function fixRooms() {
            const fixBtn = document.getElementById('fixBtn');
            fixBtn.disabled = true;
            fixBtn.textContent = 'Fixing...';
            
            try {
                log("üîß Starting to fix room documents...");
                updateStatus("Fixing room documents...", 'info');
                
                // Get all rooms from comlabrooms collection
                const roomsSnapshot = await getDocs(collection(db, "comlabrooms"));
                
                if (roomsSnapshot.empty) {
                    log("‚ùå No rooms found in comlabrooms collection");
                    updateStatus("No rooms found!", 'error');
                    return;
                }
                
                log(`üìã Found ${roomsSnapshot.size} rooms`);
                
                let fixedCount = 0;
                
                // Process each room
                for (const roomDoc of roomsSnapshot.docs) {
                    const roomId = roomDoc.id;
                    const roomData = roomDoc.data();
                    
                    // Extract room number from document ID (assuming IDs are like "517", "518", etc.)
                    const roomNumber = parseInt(roomId) || roomId;
                    
                    // Update the room document with roomNumber field
                    await updateDoc(doc(db, "comlabrooms", roomId), {
                        roomNumber: roomNumber,
                        lastUpdated: new Date()
                    });
                    
                    log(`‚úÖ Fixed room ${roomNumber} (${roomId})`);
                    fixedCount++;
                }
                
                log(`üéâ Successfully fixed ${fixedCount} room documents!`);
                updateStatus(`Successfully fixed ${fixedCount} room documents!`, 'success');
                
            } catch (error) {
                log(`‚ùå Error fixing room documents: ${error.message}`);
                updateStatus("Error occurred while fixing room documents", 'error');
                console.error("Error fixing room documents:", error);
            } finally {
                fixBtn.disabled = false;
                fixBtn.textContent = 'Fix Room Documents';
            }
        }

        async function createPCs() {
            const createBtn = document.getElementById('createPCsBtn');
            createBtn.disabled = true;
            createBtn.textContent = 'Creating...';
            
            try {
                log("üöÄ Starting to create PC documents...");
                updateStatus("Creating PC documents...", 'info');
                
                // Get all rooms from comlabrooms collection
                const roomsSnapshot = await getDocs(collection(db, "comlabrooms"));
                
                if (roomsSnapshot.empty) {
                    log("‚ùå No rooms found in comlabrooms collection");
                    updateStatus("No rooms found!", 'error');
                    return;
                }
                
                log(`üìã Found ${roomsSnapshot.size} rooms`);
                
                let totalPCsCreated = 0;
                
                // Process each room
                for (const roomDoc of roomsSnapshot.docs) {
                    const roomId = roomDoc.id;
                    const roomData = roomDoc.data();
                    const roomNumber = roomData.roomNumber || roomId;
                    
                    log(`üè† Processing Room ${roomNumber} (${roomId})...`);
                    
                    // Create PC documents (pc1 to pc30) for this room
                    for (let i = 1; i <= 30; i++) {
                        const pcId = `pc${i}`;
                        const pcDocRef = doc(db, "comlabrooms", roomId, pcId, "document1");
                        
                        // Create the PC document with default status
                        await setDoc(pcDocRef, {
                            status: "available", // Default status
                            pcNumber: i,
                            roomId: roomId,
                            roomNumber: roomNumber,
                            createdAt: new Date(),
                            lastUpdated: new Date()
                        });
                        
                        totalPCsCreated++;
                    }
                    
                    log(`‚úÖ Created 30 PCs for Room ${roomNumber}`);
                }
                
                log(`üéâ Successfully created ${totalPCsCreated} PC documents!`);
                log("üìä Each room now has pc1-pc30 with 'available' status");
                
                updateStatus(`Successfully created ${totalPCsCreated} PC documents!`, 'success');
                
            } catch (error) {
                log(`‚ùå Error creating PC documents: ${error.message}`);
                updateStatus("Error occurred while creating PC documents", 'error');
                console.error("Error creating PC documents:", error);
            } finally {
                createBtn.disabled = false;
                createBtn.textContent = 'Create PC Documents';
            }
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        async function login() {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            
            if (!email || !password) {
                log("‚ùå Please enter both email and password");
                return;
            }
            
            try {
                log("üîê Attempting to login...");
                await signInWithEmailAndPassword(auth, email, password);
                log("‚úÖ Login successful!");
                
                // Hide login form, show authenticated section
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('authenticatedSection').style.display = 'block';
                updateStatus("Logged in successfully! Ready to fix room documents.", 'success');
                
            } catch (error) {
                log(`‚ùå Login failed: ${error.message}`);
                updateStatus("Login failed. Please check your credentials.", 'error');
            }
        }

        async function logout() {
            try {
                await signOut(auth);
                log("üëã Logged out successfully");
                
                // Show login form, hide authenticated section
                document.getElementById('loginForm').style.display = 'block';
                document.getElementById('authenticatedSection').style.display = 'none';
                updateStatus("Logged out. Please log in to fix room documents.", 'info');
                
            } catch (error) {
                log(`‚ùå Logout failed: ${error.message}`);
            }
        }

        // Check authentication state on page load
        auth.onAuthStateChanged((user) => {
            if (user) {
                log("‚úÖ User is already authenticated");
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('authenticatedSection').style.display = 'block';
                updateStatus("Already logged in! Ready to fix room documents.", 'success');
            } else {
                log("‚ÑπÔ∏è No user authenticated");
                document.getElementById('loginForm').style.display = 'block';
                document.getElementById('authenticatedSection').style.display = 'none';
            }
        });

        // Make functions globally available
        window.fixRooms = fixRooms;
        window.createPCs = createPCs;
        window.clearLog = clearLog;
        window.login = login;
        window.logout = logout;
    </script>
</body>
</html>

